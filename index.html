<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Archive</title>
    <link rel="stylesheet" href="style.css">
    <script>
        if (!sessionStorage.getItem('auth')) {
            location.href = 'login.html';
        }
    </script>
</head>
<body>
    <nav class="topbar">
        <div class="top-inner">
            <div class="logo">üì¶ My Archive</div>
            <div class="top-links">
                <a href="index.html">Home</a>
                <a href="index.html?cat=diary">Diary</a>
                <a href="index.html?cat=photos">Photos</a>
            </div>
            <button class="menu-btn" id="menuBtn">‚ò∞</button>
        </div>
    </nav>

    <div class="layout">
        <aside class="sidebar" id="sidebar">
            <div id="sub-menu"></div>
        </aside>

        <main class="content">
            <div id="post-list"></div>
        </main>
    </div>

    <script>
        document.getElementById('menuBtn').onclick = () => {
            document.getElementById('sidebar').classList.toggle('open');
        };

        document.addEventListener('DOMContentLoaded', () => {
            const list = document.getElementById('post-list');
            const subMenu = document.getElementById('sub-menu');
            const params = new URLSearchParams(location.search);
            const category = params.get('cat');
            const sub = params.get('sub');

            // Ï∫êÏãú Î∞©ÏßÄÎ•º ÏúÑÌï¥ v=Date.now()Î•º Ï∂îÍ∞ÄÌñàÏäµÎãàÎã§.
            fetch('posts/index.json?v=' + Date.now())
                .then(res => res.json())
                .then(posts => {
                    let filtered = posts;
                    if (category) filtered = filtered.filter(p => p.category === category);

                    if (category === 'diary') {
                        const subs = [...new Set(posts.filter(p => p.category === 'diary' && p.sub).map(p => p.sub))];
                        if (subs.length > 0) {
                            let html = `<a href="index.html?cat=diary" class="${!sub ? 'active' : ''}">Ï†ÑÏ≤¥</a>`;
                            subs.forEach(s => {
                                html += `<a href="index.html?cat=diary&sub=${encodeURIComponent(s)}" class="${sub === s ? 'active' : ''}">${s}</a>`;
                            });
                            subMenu.innerHTML = html;
                        }
                    }

                    if (sub) filtered = filtered.filter(p => p.sub === sub);
                    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

                    list.innerHTML = '';
                    filtered.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'post-item';
                        item.innerHTML = `
                            <h3>${p.title}</h3>
                            <div class="date">${p.date}</div>
                            <p>${p.excerpt || 'ÎÇ¥Ïö© Î≥¥Í∏∞...'}</p>
                        `;
                        item.onclick = () => {
                            const from = category === 'diary' ? (sub ? `diary-${sub}` : 'diary-all') : 'home';
                            
                            // ÌååÏùºÎ™Ö Ï≤òÎ¶¨Î•º Í∞ÄÏû• Ïú†Ïó∞ÌïòÍ≤å ÏàòÏ†ïÌñàÏäµÎãàÎã§.
                            let fileName = p.file;
                            if (!fileName.includes('.')) {
                                fileName += '.json';
                            }
                            
                            location.href = `viewer.html?post=posts/${fileName}&from=${from}`;
                        };
                        list.appendChild(item);
                    });
                });
        });
    </script>
</body>
</html>
