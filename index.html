<script>
  document.getElementById("menuBtn").onclick = () => {
    document.getElementById("sidebar").classList.toggle("open");
  };

  document.addEventListener("DOMContentLoaded", () => {
    const list = document.getElementById("post-list");
    const subMenu = document.getElementById("sub-menu");
    const params = new URLSearchParams(location.search);
    const category = params.get("cat");
    const sub = params.get("sub");

    fetch("posts/index.json?v=" + new Date().getTime())
      .then(r => r.json())
      .then(originalPosts => {
        let posts = originalPosts.filter(p => p && p.title && p.date);
        if (category) posts = posts.filter(p => p.category === category);
        
        if (category === "diary") {
          const subs = [...new Set(posts.filter(p => p.sub).map(p => p.sub))];
          if (subs.length) {
            subMenu.innerHTML = `<a href="index.html?cat=diary"${!sub ? ' class="active"' : ''}>전체</a>` +
              subs.map(s => `<a href="index.html?cat=diary&sub=${encodeURIComponent(s)}"${sub === s ? ' class="active"' : ''}>${s}</a>`).join("");
          }
        }

        if (sub) posts = posts.filter(p => p.sub === sub);
        posts.sort((a, b) => new Date(b.date) - new Date(a.date));
        list.innerHTML = "";

        posts.forEach(p => {
          const item = document.createElement("div");
          item.className = "post-item";
          item.innerHTML = `<h3>${p.title}</h3><span class="date">${p.date}</span><p>${p.excerpt || "내용 보기"}</p>`;

          item.onclick = () => {
            let from = category === "diary" ? (sub ? `diary-${sub}` : "diary-all") : "home";
            
            // ✅ 수정한 부분: 이제 "(하)"가 있든 없든 정직하게 불러옵니다.
            // 1. file 항목이 있으면 그걸 최우선으로 씁니다.
            // 2. file 항목이 없으면 date 항목을 파일명으로 씁니다.
            let fileName = p.file || p.date;

            if (!fileName.endsWith('.json')) {
              fileName += '.json';
            }

            const finalUrl = `viewer.html?post=posts/${fileName}&from=${encodeURIComponent(from)}`;
            console.log("이동 경로:", finalUrl);
            location.href = finalUrl;
          };
          list.appendChild(item);
        });
      });
  });
</script>
