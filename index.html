<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Archive</title>
  <link rel="stylesheet" href="style.css"/>
  <script>
    if (!sessionStorage.getItem("auth")) {
      location.href = "login.html";
    }
  </script>
</head>
<body>

<nav class="topbar">
  <div class="top-inner">
    <div class="logo">ğŸ“¦ My Archive</div>
    <div class="top-links">
      <a href="index.html">Home</a>
      <a href="index.html?cat=diary">Diary</a>
      <a href="index.html?cat=photos">Photos</a>
    </div>
    <button class="menu-btn" id="menuBtn">â˜°</button>
  </div>
</nav>

<div class="layout">
  <aside class="sidebar" id="sidebar">
    <div id="sub-menu"></div>
  </aside>
  <main class="content">
    <div id="post-list"></div>
  </main>
</div>

<script>
  document.getElementById("menuBtn").onclick = () => {
    document.getElementById("sidebar").classList.toggle("open");
  };

  document.addEventListener("DOMContentLoaded", () => {
    const list = document.getElementById("post-list");
    const subMenu = document.getElementById("sub-menu");
    const params = new URLSearchParams(location.search);
    const category = params.get("cat");
    const sub = params.get("sub");

    // posts/index.jsonì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ í˜„ì¬ ì‹œê°„ íŒŒë¼ë¯¸í„°ë¥¼ ë¶™ì˜€ìŠµë‹ˆë‹¤.
    fetch("posts/index.json?v=" + new Date().getTime())
      .then(r => {
        if (!r.ok) throw new Error("íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return r.json();
      })
      .then(originalPosts => {
        // ë°ì´í„°ê°€ ìœ íš¨í•œì§€ í•„í„°ë§
        let posts = originalPosts.filter(p => p && p.title && p.date);
        
        // ì¹´í…Œê³ ë¦¬ í•„í„°ë§
        if (category) posts = posts.filter(p => p.category === category);
        
        // ì„œë¸Œ ë©”ë‰´ êµ¬ì„± (diary ì¹´í…Œê³ ë¦¬ì¼ ë•Œ)
        if (category === "diary") {
          const subs = [...new Set(posts.filter(p => p.sub).map(p => p.sub))];
          if (subs.length) {
            subMenu.innerHTML = `<a href="index.html?cat=diary"${!sub ? ' class="active"' : ''}>ì „ì²´</a>` +
              subs.map(s => `<a href="index.html?cat=diary&sub=${encodeURIComponent(s)}"${sub === s ? ' class="active"' : ''}>${s}</a>`).join("");
          }
        }

        // ì„œë¸Œ ì¹´í…Œê³ ë¦¬ í•„í„°ë§
        if (sub) posts = posts.filter(p => p.sub === sub);
        
        // ìµœì‹ ìˆœ ì •ë ¬
        posts.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        list.innerHTML = "";

        posts.forEach(p => {
          const item = document.createElement("div");
          item.className = "post-item";
          item.innerHTML = `<h3>${p.title}</h3><span class="date">${p.date}</span><p>${p.excerpt || "ë‚´ìš© ë³´ê¸°"}</p>`;

          item.onclick = () => {
            let from = category === "diary" ? (sub ? `diary-${sub}` : "diary-all") : "home";
            
            // âœ… ìˆ˜ì •í•œ í•µì‹¬ ë¶€ë¶„: 
            // 1. file í•­ëª©ì´ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ dateë¥¼ íŒŒì¼ëª…ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            // 2. ì œëª©ì— '(í•˜)'ê°€ ìˆì–´ë„ ê°•ì œë¡œ íŒŒì¼ëª…ì„ ë°”ê¾¸ì§€ ì•ŠìŠµë‹ˆë‹¤.
            let fileName = p.file || p.date;

            // í™•ì¥ì ì¤‘ë³µ ë°©ì§€
            if (!fileName.toString().endsWith('.json')) {
              fileName += '.json';
            }

            const finalUrl = `viewer.html?post=posts/${fileName}&from=${encodeURIComponent(from)}`;
            location.href = finalUrl;
          };
          list.appendChild(item);
        });
      })
      .catch(err => {
        console.error("ì˜¤ë¥˜ ë°œìƒ:", err);
        list.innerHTML = "<p style='padding:20px;'>ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. index.json íŒŒì¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>";
      });
  });
</script>
</body>
</html>
